<html>

<head>
    <title>suntonels</title>
</head>

<body>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.68/Tone.js"></script>
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/startaudiocontext@1.2.1/StartAudioContext.min.js"></script>
    <script type="text/javascript" src="./tune-master/tune.js"></script>
    <script type="text/javascript" src="./PapaParse-5.0.2/papaparse.min.js"></script>
    <script type="module">
        // set up tune for alt scales
        const tune = new Tune();
        tune.loadScale("mean19");
        tune.tonicize(220);

        // alias tune.note for shorter access
        const tn = tune.note.bind(tune);

        let parsedSensorData = null;

        // parse CSV before starting to play
        Papa.parse("./sensor_data.csv", {
            download: true,
            complete: function (results) {
                console.log("loaded csv");
                parsedSensorData = results;
                StartAudioContext(Tone.context).then(play);
            }
        })

        const play = async () => {
            // synths
            const synthA = new Tone.FMSynth();
            const synthB = new Tone.AMSynth();
            const synthC = new Tone.PolySynth(Tone.Synth);
            const pulse = new Tone.PulseOscillator();

            // fx
            const distortion = new Tone.Distortion(0.05);
            const chorus = new Tone.Chorus(4, 2.5, 0.5);
            const reverb = new Tone.Reverb();
            const delay = new Tone.Delay(0.3);

            // synths to fx
            synthA.connect(distortion);
            synthB.connect(distortion);
            pulse.connect(delay);
            synthC.connect(reverb);

            // inter-fx connex
            distortion.connect(chorus);

            // fx to destination
            delay.toDestination();
            reverb.toDestination();
            chorus.toDestination();
            synthC.toDestination();

            // map sensor data into individual arrays
            const accelXData = parsedSensorData.data.map(([timestamp,accelX,accelY,accelZ,magX,magY,magZ]) => accelX * 40);
            const accelYData = parsedSensorData.data.map(([timestamp,accelX,accelY,accelZ,magX,magY,magZ]) => accelY * -15);
            const accelZData = parsedSensorData.data.map(([timestamp,accelX,accelY,accelZ,magX,magY,magZ]) => accelZ * 200);

            // create sequences
            const accelXSeq = new Tone.Sequence((time, note) => {
                console.log(`sequencing note ${note} at time ${time}`);
                synthC.triggerAttackRelease(note, 0.2, time);
            }, accelXData).start(0);

            const accelYSeq = new Tone.Sequence((time, note) => {
                console.log(`sequencing note ${note} at time ${time}`);
                synthB.triggerAttackRelease(note, 0.2, time);
            }, accelYData).start(0);

            const accelZSeq = new Tone.Sequence((time, note) => {
                console.log(`sequencing note ${note} at time ${time}`);
                pulse.triggerAttackRelease(note, 0.2, time);
            }, accelZData).start(0);

            Tone.Transport.bpm.value = 160;

            // the loops start when the Transport is started
            Tone.Transport.start();
        };

    </script>
</body>

</html>